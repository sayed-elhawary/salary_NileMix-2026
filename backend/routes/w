const express = require('express');
const bcrypt = require('bcryptjs');
const User = require('../models/User');
const Shift = require('../models/Shift');
const Attendance = require('../models/Attendance');
const SalaryAdjustment = require('../models/SalaryAdjustment');
const router = express.Router();

// دالة لتقريب الأرقام إلى خانتين عشريتين
const roundNumber = (num) => Number(num.toFixed(2));

router.get('/', async (req, res) => {
  try {
    const users = await User.find().populate('shiftType');
    res.json(users);
  } catch (err) {
    console.error('Error in GET /user:', err);
    res.status(500).json({ success: false, message: `حدث خطأ، حاول مرة أخرى: ${err.message}` });
  }
});

router.get('/shifts', async (req, res) => {
  try {
    const shifts = await Shift.find();
    res.json(shifts);
  } catch (err) {
    console.error('Error in GET /shifts:', err);
    res.status(500).json({ success: false, message: `حدث خطأ أثناء جلب الشيفتات: ${err.message}` });
  }
});

router.post('/create', async (req, res) => {
  try {
    const { password, ...otherData } = req.body;
    const hashedPassword = await bcrypt.hash(password, 10);
    const user = new User({ ...otherData, password: hashedPassword });
    await user.save();
    res.json({ success: true });
  } catch (err) {
    console.error('Error in POST /create:', err);
    res.status(500).json({ success: false, message: `حدث خطأ، حاول مرة أخرى: ${err.message}` });
  }
});

router.put('/update/:id', async (req, res) => {
  try {
    const { password, ...otherData } = req.body;
    if (password) {
      const hashedPassword = await bcrypt.hash(password, 10);
      await User.findByIdAndUpdate(req.params.id, { ...otherData, password: hashedPassword });
    } else {
      await User.findByIdAndUpdate(req.params.id, otherData);
    }
    res.json({ success: true });
  } catch (err) {
    console.error('Error in PUT /update/:id:', err);
    res.status(500).json({ success: false, message: `حدث خطأ، حاول مرة أخرى: ${err.message}` });
  }
});

router.put('/update-many', async (req, res) => {
  try {
    const { updates, shiftType, excludedUsers, annualIncreasePercentage } = req.body;
    let filter = shiftType ? { shiftType } : {};
    if (excludedUsers && excludedUsers.length > 0) {
      filter._id = { $nin: excludedUsers };
    }
    if (annualIncreasePercentage) {
      await User.updateMany(filter, [
        {
          $set: {
            basicSalary: { $multiply: ['$basicSalary', 1 + annualIncreasePercentage / 100] },
            netSalary: {
              $add: [
                { $multiply: ['$basicSalary', 1 + annualIncreasePercentage / 100] },
                '$basicBonus',
                '$mealAllowance',
              ],
            },
          },
        },
      ]);
    } else {
      await User.updateMany(filter, updates);
    }
    res.json({ success: true });
  } catch (err) {
    console.error('Error in PUT /update-many:', err);
    res.status(500).json({ success: false, message: `حدث خطأ، حاول مرة أخرى: ${err.message}` });
  }
});

router.delete('/delete/:id', async (req, res) => {
  try {
    await User.findByIdAndDelete(req.params.id);
    res.json({ success: true });
  } catch (err) {
    console.error('Error in DELETE /delete/:id:', err);
    res.status(500).json({ success: false, message: `حدث خطأ أثناء الحذف: ${err.message}` });
  }
});

router.get('/monthly-salary-report', async (req, res) => {
  try {
    const { month, year, employeeCode, shiftId } = req.query;

    // التحقق من صحة المدخلات
    if (!month || !year || isNaN(month) || isNaN(year) || month < 1 || month > 12) {
      return res.status(400).json({ success: false, message: 'يجب إدخال شهر وسنة صالحين' });
    }

    const startDate = `${year}-${month.padStart(2, '0')}-01`;
    const endDate = new Date(year, month, 0).toISOString().split('T')[0];

    let userFilter = {};
    if (employeeCode) userFilter.employeeCode = employeeCode;
    if (shiftId) userFilter.shiftType = shiftId;

    const users = await User.find(userFilter).populate('shiftType');
    const reports = [];

    for (const user of users) {
      // التحقق من وجود shiftType
      if (!user.shiftType) {
        console.warn(`User ${user.employeeCode} has no valid shiftType`);
        continue;
      }

      const shift = user.shiftType;

      // التحقق من baseHours
      if (!shift.baseHours || shift.baseHours <= 0) {
        console.warn(`Invalid baseHours for user ${user.employeeCode}`);
        continue;
      }

      const attendanceQuery = {
        employeeCode: user.employeeCode,
        date: { $gte: startDate, $lte: endDate }
      };
      const attendances = await Attendance.find(attendanceQuery);

      let totalAttendanceDays = 0;
      let totalWeeklyOffDays = 0;
      let totalOfficialLeaveDays = 0;
      let totalAbsentDays = 0;
      let totalOvertimeHours = 0;
      let totalDeductedHours = 0;
      let totalDeductedDays = 0;
      let totalAnnualLeaveDays = 0;
      let totalSickLeaveDeduction = 0;
      let totalLeaveAllowance = 0;

      for (const att of attendances) {
        if (att.attendanceStatus === 'حاضر' || att.attendanceStatus === 'متأخر') totalAttendanceDays++;
        if (att.attendanceStatus === 'إجازة أسبوعية') totalWeeklyOffDays++;
        if (att.attendanceStatus === 'إجازة رسمية') totalOfficialLeaveDays++;
        if (att.attendanceStatus === 'غائب') totalAbsentDays++;
        totalOvertimeHours += att.overtimeHours || 0;
        // فحص إضافي للتأكد من أن totalDeductedHours منطقي
        totalDeductedHours += (att.deductedHours && att.deductedHours < 100) ? att.deductedHours : 0;
        totalDeductedDays += att.deductedDays || 0;
        if (att.attendanceStatus === 'إجازة سنوية') totalAnnualLeaveDays++;
        if (att.attendanceStatus === 'إجازة مرضية') totalSickLeaveDeduction += att.deductedDays || 0;
        if (att.leaveAllowance === 'نعم') totalLeaveAllowance += 1;
      }

      const adjustment = await SalaryAdjustment.findOne({ employeeCode: user.employeeCode, month: `${year}-${month.padStart(2, '0')}` }) || {
        occasionBonus: 0,
        totalViolations: 0,
        deductionViolationsInstallment: 0,
        totalAdvances: 0,
        deductionAdvancesInstallment: 0,
      };

      // حساب خصم بدل الوجبة: 50 ريال لكل يوم غياب، إجازة سنوية، أو إجازة رسمية
      const mealDeductionPerDay = 50;
      const mealDeductionDays = totalAbsentDays + totalAnnualLeaveDays + totalOfficialLeaveDays;
      const mealDeduction = roundNumber(Math.min(mealDeductionDays * mealDeductionPerDay, user.mealAllowance));
      const remainingMealAllowance = roundNumber(user.mealAllowance - mealDeduction);

      const dailyRate = roundNumber(user.basicSalary / 30);
      const hourlyRate = roundNumber(user.basicSalary / (30 * shift.baseHours));

      // التحقق من نوع الخصم
      const hasMinutesDeduction = shift.deductions ? shift.deductions.some(d => d.type === 'minutes') : false;
      const deductedDaysAmount = roundNumber(totalDeductedDays * dailyRate);
      const deductedHoursAmount = hasMinutesDeduction ? roundNumber(totalDeductedHours * hourlyRate) : 0;
      const sickDeductionAmount = roundNumber(totalSickLeaveDeduction * dailyRate);
      const overtimeAmount = roundNumber(totalOvertimeHours * hourlyRate); // استخدام الساعة العادية
      const leaveAllowanceAmount = roundNumber(totalLeaveAllowance * dailyRate);

      // إجمالي قيمة الخصومات
      const totalDeductions = roundNumber(
        user.medicalInsurance +
        user.socialInsurance +
        deductedDaysAmount +
        deductedHoursAmount +
        adjustment.deductionViolationsInstallment +
        adjustment.deductionAdvancesInstallment +
        sickDeductionAmount +
        mealDeduction
      );

      // إجمالي الإضافي
      const totalAdditions = roundNumber(
        user.basicSalary +
        user.mealAllowance +
        adjustment.occasionBonus +
        overtimeAmount +
        leaveAllowanceAmount
      );

      // الصافي
      const net = roundNumber(totalAdditions - totalDeductions);

      reports.push({
        employeeCode: user.employeeCode,
        name: user.name,
        basicSalary: roundNumber(user.basicSalary),
        medicalInsurance: roundNumber(user.medicalInsurance),
        socialInsurance: roundNumber(user.socialInsurance),
        mealAllowance: roundNumber(user.mealAllowance),
        mealDeduction: roundNumber(mealDeduction),
        remainingMealAllowance: roundNumber(remainingMealAllowance),
        shiftType: shift.shiftName,
        totalAttendanceDays,
        totalWeeklyOffDays,
        totalLeaveAllowance,
        totalAbsentDays,
        totalDeductedHours: roundNumber(totalDeductedHours),
        totalAnnualLeaveDays,
        totalSickLeaveDeduction: roundNumber(totalSickLeaveDeduction),
        annualLeaveBalance: user.annualLeaveBalance,
        totalOfficialLeaveDays,
        totalDeductedDays: roundNumber(totalDeductedDays),
        totalOvertimeHours: roundNumber(totalOvertimeHours),
        occasionBonus: roundNumber(adjustment.occasionBonus),
        totalViolations: roundNumber(adjustment.totalViolations),
        deductionViolationsInstallment: roundNumber(adjustment.deductionViolationsInstallment),
        totalAdvances: roundNumber(adjustment.totalAdvances),
        deductionAdvancesInstallment: roundNumber(adjustment.deductionAdvancesInstallment),
        totalDeductions: totalDeductions,
        totalAdditions: totalAdditions,
        netSalary: net,
      });
    }

    res.json(reports);
  } catch (err) {
    console.error('Error in GET /monthly-salary-report:', {
      message: err.message,
      stack: err.stack,
      query: req.query,
    });
    res.status(500).json({ success: false, message: `حدث خطأ: ${err.message}` });
  }
});

module.exports = router;
